const fcnen_modal=document.getElementById("fcnen-subscription-modal"),fcnen_targetContainer=fcnen_modal?.querySelector('[data-target="fcnen-modal-loader"]'),fcnen_url_params=Object.fromEntries(new URLSearchParams(window.location.search).entries());function fcnen_addEventListeners(){document.querySelector('[data-click-action="auth-mode"]')?.addEventListener("click",(()=>{fcnen_modal.querySelector('[data-target="auth-mode"]').hidden=!1,fcnen_modal.querySelector('[data-target="submit-mode"]').hidden=!0})),document.querySelector('[data-click-action="submit-mode"]')?.addEventListener("click",(()=>{fcnen_modal.querySelector('[data-target="auth-mode"]').hidden=!0,fcnen_modal.querySelector('[data-target="submit-mode"]').hidden=!1})),document.getElementById("fcnen-modal-submit-button")?.addEventListener("click",(e=>{fcnen_subscribe_or_update(e.currentTarget)})),document.getElementById("fcnen-modal-auth-button")?.addEventListener("click",(()=>{fcnen_getModalForm("edit")})),document.querySelector('[data-click-action="fcnen-delete-subscription"]')?.addEventListener("click",(()=>{fcnen_unsubscribe()})),document.getElementById("fcnen-modal-checkbox-scope-everything")?.addEventListener("change",(e=>{fcnen_modal.querySelector("form").classList.toggle("_everything",e.currentTarget.checked)}))}function fcnen_toggleInProgress(e=!0){fcnen_targetContainer.classList.toggle("ajax-in-progress",e)}function fcnen_getPreparedFormData(e){let n=new FormData(e),t={};for(let[e,c]of n.entries()){let n=e.replace(/\[\]/g,"");t.modifiedKey?t[n].push(c):t[n]=[c]}for(let e in t)Array.isArray(t[e])&&(t[e]=t[e].join(","));return t}function fcnen_getModalForm(e="new"){if("new"==e&&document.getElementById("fcnen-subscription-form"))return;const n=fcnen_url_params["fcnen-email"]??document.getElementById("fcnen-modal-auth-email")?.value??0,t=fcnen_url_params["fcnen-code"]??document.getElementById("fcnen-modal-auth-code")?.value??0;if("edit"==e&&!n&&!t)return;"edit"==e&&fcnen_toggleInProgress();fcn_ajaxPost({action:"fcnen_ajax_get_form_content","auth-email":n,"auth-code":t}).then((e=>{e.success&&(fcnen_targetContainer.innerHTML=e.data.html)})).then((()=>{fcnen_toggleInProgress(!1),fcnen_addEventListeners()}))}function fcnen_subscribe_or_update(e){const n=e.closest("form"),t=document.getElementById("fcnen-modal-submit-email")?.value,c=fcnen_getPreparedFormData(n);if(!t)return void n.reportValidity();fcnen_toggleInProgress();let a={action:"fcnen_ajax_subscribe_or_update",email:t,nonce:fcnen_modal.querySelector('input[name="nonce"]')?.value??""};a={...a,...c},fcn_ajaxPost(a).then((e=>{fcnen_targetContainer.innerHTML=`<div class="fcnen-dialog-modal__notice"><p>${e.data.notice}</p></div>`,fcnen_toggleInProgress(!1)}))}function fcnen_unsubscribe(){fcnen_toggleInProgress();const e={action:"fcnen_ajax_subscribe",email:document.getElementById("fcnen-modal-submit-email")?.value??"",code:document.getElementById("fcnen-modal-submit-code")?.value??0,nonce:fcnen_modal.querySelector('input[name="nonce"]')?.value??""};fcn_ajaxPost(e).then((e=>{fcnen_targetContainer.innerHTML=`<div class="fcnen-dialog-modal__notice"><span>${e.data.notice}</span></div>`,fcnen_toggleInProgress(!1)}))}fcnen_modal&&(document.querySelectorAll('[data-click-action*="fcnen-load-modal-form"]').forEach((e=>{e.addEventListener("click",(()=>{fcnen_getModalForm()}),{once:!0})})),fcnen_url_params["fcnen-email"]&&fcnen_url_params["fcnen-code"]&&document.addEventListener("DOMContentLoaded",(()=>{setTimeout((()=>{fcnen_modal.showModal(),fcnen_getModalForm()}),100)}))),history.replaceState&&history.replaceState(null,"",location.pathname+location.search.replace(/[?&](fcnen-email|fcnen-code|fcnen-action|fcnen|)=[^&]+/g,"").replace(/^[?&]/,"?")+location.hash);